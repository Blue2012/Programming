# bat一般論的なループ処理の実装
なんかサイトで調べてみるとラベルとgoto文で書くのが一般的な話が書かれているのですが、あまり融通が効かない書き方が多い。   
ちょっと案件で扱ってみて、参考になったので、ここに忘れないようにメモっておこうと思います。   

<img width="766" alt="image" src="https://user-images.githubusercontent.com/18514297/221322411-f0e99555-b114-44cc-be1a-13177b238198.png">

一般的にはfor文で開始番号と終了番号を指定して、指定した回数分だけループ処理を回すというもののようです。   
今回は変数の数だけループ処理を回す実装をする方法をメモっておく。

# 画期的なループ
簡単に言うと以下のようなメイン処理を書いて、その下に各処理をラベルで分けて書いてやるって感じです。　   
何が配列になるかと言うと、テキストファイル内に複数の変数値を記載し、ファイルを読み込み、変数を読み込む構成。   
ループ処理に渡す変数が増えるたびにA、B、Cっていう感じで増やしていけば、ループに回せる変数の数を増やすことができます。   

つまり、ファイルの中に変数の実態となる値を記載して、メイン処理のループ文の中に変数名を増やしてやることで受け取れるようになります。   
tokensという箇所でデリミタで区切られたデータの何番目を取得するかを指定することができる。   

<img width="792" alt="image" src="https://user-images.githubusercontent.com/18514297/221321978-0f8d02db-566d-43ff-a471-cd75c37a7ef0.png">

%%でアルファベットを指定している箇所のアルファベット名は何でも良いが連続して指定するので連続性が分かりやすい文字を採用すると良い。   
メイン処理は以下のような形で実装する。   

```cmd
for /f "tokens=1-2 delims= " %%A in (%テキストファイル名%) do (
	set 変数名1=%%A
	set 変数名2=%%B
	
	call :ラベル名1
	call :ラベル名2
)

GOTO END
```

そして、サブルーチンは以下のように記載する。   

```cmd
ラベル名1：
処理内容
```
総合すると以下のようなスクリプトになる。  
ちなみにテキストの内容は以下の通り、forの既定のデリミタはオプションで指定しない限りは半角スペースかタブが指定されるとのこと。   
「トークン」というのはいわば「カラム」のこと。各行の指定した列番号に位置するカラムデータを取得できる。   
以下の例で言えば、各行のコピー元フォルダパス、コピー先フォルダパスを取得して、それぞれ、AとBの変数に格納する。   

```cmd
C:\Program Files\work\before1 C:\Program Files\work\After1
C:\Program Files\work\before2 C:\Program Files\work\After2
```

以下のように記載することでテキストファイルから取得した変数データを1セットにコピー処理とリネーム処理を一気通貫で流しつつ、   
指定した変数の数の分だけループ処理を回すという画期的な実装を実現できる。

```cmd

REM ----------------------------------------------------------------------------
REM ■変数定義
REM ----------------------------------------------------------------------------

REM -----バッチファイル実行日取得-----
set filedate=%DATE:~-8,2%%DATE:~-5,2%%DATE:~-2%

REM ------ログ出力-----
set BATCHNAME=filecopy
set BATCHLOG=C:\work\log\filecopy_%filedate%.log

REM ------ログローテート用変数-----
set BATCHDIR=C:\work
set BATCHLOGDIR=%BATCHDIR%\log
set TMPDIR=%BATCHDIR%\tmp

REM ------リストファイル-----
set listfile=C:\work\conf\filecopy.list

REM ------返り値の初期化-----
set RETURNCODE=0

CALL :LOGGING Info: "▼ファイルコピープログラム開始"

REM ----------------------------------------------------------------------------
REM ■リストファイルの存在確認
REM ----------------------------------------------------------------------------

set listfile=C:\Work\script.txt

IF NOT EXIST %listfile% (
	CALL :LOGGING Error: "ListFile（%listfile%）が見つかりませんでした。returncode=8"
	SET RETURNCODE=8
	GOTO END
) ELSE (
	CALL :LOGGING Info: " ListFile（%listfile%）を確認しました。returncode=0"
)

REM ----------------------------------------------------------------------------
REM ■メイン処理
REM ----------------------------------------------------------------------------

for /f "tokens=1-2 delims= " %%A in (%listfile%) do (
	set sourcepath=%%A
	set destpath=%%B
	
	call :copy
	call :rename
)

REM -----------------------------------------------------------------------------
REM ■コピー処理
REM -----------------------------------------------------------------------------
:copy
set sourcefilename=test1.txt
set destfilename=newtest1.txt
copy %sourcepath%%sourcefilename% %destpath%%destfilename%

REM -----------------------------------------------------------------------------
REM ■リネーム処理
REM -----------------------------------------------------------------------------
:rename
set renamefile=renametest1.txt
REN %destpath%%destfilename% %destpath%%renamefile%

REM -----------------------------------------------------------------------------
REM ■ログ出力ルーチン
REM 第一引数：　エラーレベル（Info, Warn, Erro）
REM 第二引数：　メッセージ
REM -----------------------------------------------------------------------------
:LOGGING
ECHO %DATE:~-10% %TIME:~0,8% %BATCHNAME% %1 %~2 >> %BATCHLOG%
ECHO %DATE:~-10% %TIME:~0,8% %BATCHNAME% %1 %~2 >&2
EXIT /B !RETURNCODE!

GOTO END

REM -----------------------------------------------------------------------------
REM ■処理終了
REM -----------------------------------------------------------------------------
:END
REM 終了ログ出力
CALL :LOGGING Info: "▲ファイルコピープログラム終了"

exit

```
